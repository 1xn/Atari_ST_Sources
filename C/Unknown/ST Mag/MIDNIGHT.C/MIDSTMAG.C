#include <vdi.h>
#include <tos.h>
#include <stdio.h>
#include <stdlib.h>
#include <portab.h>
#include <midnight.h>

#define entete MOD_struct

extern MOD_str MOD_struct;

Value	Values[4] =		/* Boutons de r‚glages du module */
	{
		T_BUTTON, 0, (long)"Effacer ‚cran", "\0",
		T_SLIDER, (long)"D‚coiffante\0Normale\0TraŒnante\0\0", 3, "Vitesse",
		T_POPUP, 0, (long)"Opaque\0Invers‚\0\0", "Modes",
		T_TITEL|T_END, 0, 0, "1.1 C. Attard (id‚e M. Abramson)"
	};

Value	*Value_s = Values;		/* D‚signe une liste de pointeurs	*/

int pxy[8], *buffer;
MFDB nul = {0};
volatile static int handle;

/* Description bitmap monochrome des quatre logos qui seront affich‚s */
	/* Logo Application Systems */
static int apsy[] = {
	0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFF8,0x8000,0x0000,0x0000,
	0x0000,0x0008,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,
	0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,
	0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,
	0xF1C7,0x1FFF,0xFFE8,0xBFFF,0xFFFF,0xE186,0x1FFF,0xFFE8,
	0xBFFF,0xFFFF,0xE186,0x1FFF,0xFFE8,0xBFFF,0xFFFF,0xC30C,
	0x3FFF,0xFFE8,0xBFFF,0xFFFF,0xC71C,0x7FFF,0xFFE8,0xBFFF,
	0xFFFF,0x8618,0x7FFF,0xFFE8,0xBFFF,0xFFFF,0x8E38,0xFFFF,
	0xFFE8,0xBFFF,0xFFFF,0x0C30,0xFFFF,0xFFE8,0xBFFF,0xFFFE,
	0x1861,0xFFFF,0xFFE8,0xBFFF,0xFFFE,0x1861,0xFFFF,0xFFE8,
	0xBFFF,0xFFFC,0x30C3,0xFFFF,0xFFE8,0xBFFF,0xFFFC,0x71C7,
	0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,
	0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,
	0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,
	0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,
	0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBE30,0xC3BE,0x3863,
	0x0638,0xDDE8,0xBDD7,0x5DBF,0x77DD,0xDF77,0x4DE8,0xBC10,
	0xC3BF,0x77C1,0xDF77,0x55E8,0xBDD7,0xDFBF,0x77DD,0xDF77,
	0x59E8,0xBDD7,0xDF86,0x385D,0xDE38,0xDDE8,0xBFFF,0xFFFF,
	0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,
	0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,
	0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,
	0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBE1F,0xBBF8,0x7C1F,0x07BB,
	0xE1E8,0xBDFF,0xBBF7,0xFF7F,0x7F93,0xDFE8,0xBE3F,0xD7F8,
	0xFF7F,0x0FAB,0xE3E8,0xBFDF,0xEFFF,0x7F7F,0x7FBB,0xFDE8,
	0xBC3F,0xEFF0,0xFF7F,0x07BB,0xC3E8,0xBFFF,0xFFFF,0xFFFF,
	0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,
	0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,
	0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,
	0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,
	0xBC3F,0xFC7F,0xF87F,0xF1FF,0xE1E8,0xBDDF,0xFBBF,0xFBBF,
	0xFBFF,0xDFE8,0xBC3F,0xF83F,0xF87F,0xFBFF,0xE3E8,0xBDFF,
	0xFBBF,0xFAFF,0xFBFF,0xFDE8,0xBDFF,0xFBBF,0xFB3F,0xF1FF,
	0xC3E8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,
	0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,
	0xBFFF,0xFFFF,0xFFFF,0xFFFF,0xFFE8,0xBFFF,0xFFFF,0xFFFF,
	0xFFFF,0xFFE8,0x8000,0x0000,0x0000,0x0000,0x0008,0xFFFF,
	0xFFFF,0xFFFF,0xFFFF,0xFFF8 };

	/* Logo STMag */
static int stm[] = {
	0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8000,0x0000,0x0000,0x0004,
	0x8000,0x0000,0x0000,0x0007,0x8000,0x0000,0x0000,0x0007,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8003,0xFF84,0x0000,0x0107,
	0x801F,0xFFF4,0x0000,0x0107,0x807F,0xFFF4,0x0000,0x0107,
	0x80FF,0xFFF4,0x0000,0x0107,0x80FF,0xFFF4,0x0000,0x0107,
	0x80FF,0xFFE4,0x0000,0x0107,0x81FF,0xC064,0x0000,0x0107,
	0x81FF,0xC007,0xFC01,0xFF07,0x81FF,0xC007,0xFC01,0xFF07,
	0x81FF,0xE007,0xFC01,0xFF07,0x81FF,0xF007,0xFC01,0xFF07,
	0x81FF,0xF807,0xFC01,0xFF07,0x80FF,0xFE07,0xFC01,0xFF07,
	0x807F,0xFF07,0xFC01,0xFF07,0x803F,0xFF87,0xFC01,0xFF04,
	0x801F,0xFFE7,0xFC01,0xFF07,0x8007,0xFFF7,0xFC01,0xFF07,
	0x8003,0xFFFF,0xFC01,0xFF07,0x8001,0xFFFF,0xFC01,0xFF04,
	0x8000,0x7FFF,0xFC01,0xFF07,0x8000,0x3FFF,0xFC01,0xFF07,
	0x8000,0x3FFF,0xFC01,0xFF07,0x8000,0x1FFF,0xFC01,0xFF07,
	0x8000,0x0FFF,0xFC01,0xFF07,0x8000,0x0FFF,0xFC01,0xFF07,
	0x8070,0x1FFF,0xFC01,0xFF07,0x80FF,0xFFFF,0xFC01,0xFF07,
	0x80FF,0xFFFF,0xFC01,0xFF07,0x81FF,0xFFF7,0xFC01,0xFF07,
	0x81FF,0xFFE7,0xFC01,0xFF07,0x80FF,0xFFC7,0xFC01,0xFF07,
	0x803F,0xFF07,0xFC01,0xFF07,0x8001,0xE007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0007,0xFFFF,0xFF07,
	0x8000,0x0007,0xFFFF,0xFF07,0x8000,0x0000,0x0000,0x0007,
	0x8000,0x0000,0x0000,0x0004,0xFFFF,0xFFFF,0xFFFF,0xFFFF };

	/* Logo Midnight */
static int mid[] = {
	0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8000,0x8000,0x0000,
	0x0000,0x0000,0x0000,0x8000,0x8000,0x0000,0x1800,0x0000,
	0x2000,0x8000,0x8000,0x0000,0x1800,0x0000,0x2000,0x8000,
	0x8000,0x0000,0x3800,0x0000,0x6000,0x8000,0x8000,0x0080,
	0x3800,0x0000,0x600C,0x8000,0x8000,0x0180,0x7800,0x3000,
	0xE00C,0x8000,0x8000,0x01C0,0x7000,0x3800,0xE018,0x8000,
	0x8000,0x0080,0x7000,0x3000,0xC038,0x8000,0x8000,0x0200,
	0xE000,0x0001,0xC030,0x8000,0x8310,0x060E,0xC000,0x4001,
	0x80FC,0x8000,0x8331,0x061D,0x83B0,0xC3E3,0x18F8,0x8000,
	0x8773,0x0C31,0x0371,0x8363,0x38E0,0x8000,0x87BF,0x8831,
	0x07F1,0x0662,0x7840,0x8000,0x8F3F,0x9877,0x0FB1,0x0C67,
	0xD8C0,0x8000,0x8E71,0xFFFF,0xFF3F,0xBFBF,0x9BFC,0x8000,
	0x8E71,0xDF7D,0xEE3F,0xEF3F,0x1EF8,0x8000,0x8C61,0xDE79,
	0xE63B,0xEE37,0x1CF0,0x8000,0x8000,0x0001,0x8011,0x8460,
	0x0860,0x8000,0x8000,0x0000,0x0000,0x00C0,0x0000,0x8000,
	0x8000,0x0000,0x0000,0x0180,0x0000,0x8000,0x8000,0x0000,
	0x0000,0x0380,0x0000,0x8000,0x8000,0x0000,0x0000,0x0700,
	0x0000,0x8000,0x8000,0x0000,0x0000,0x0700,0x0000,0x8000,
	0x8000,0x0000,0x0000,0x0600,0x0000,0x8000,0x8000,0x0000,
	0x0000,0x0000,0x0000,0x8000,0xFFFF,0xFFFF,0xFFFF,0xFFFF,
	0xFFFF,0x8000 };

	/* Logo Atari */
int ata[] = {
	0xFFFF,0xFFFF,0xFFFF,0x8000,0x0000,0x4000,0x8000,0x0000,
	0x5800,0x8019,0xE600,0x5800,0x8019,0xE600,0x7800,0x8019,
	0xE600,0x7800,0x8019,0xE600,0x7800,0x8019,0xE600,0x7000,
	0x8019,0xE600,0x7000,0x8019,0xE600,0x6000,0x8019,0xE600,
	0x4000,0x8079,0xE780,0x43B0,0x8079,0xE780,0x4371,0x8079,
	0xE780,0x47F1,0x8079,0xE780,0x4FB1,0x81F9,0xE7E0,0x7F3F,
	0x81F9,0xE7E0,0x6E3F,0x87E1,0xE1F8,0x663B,0x87E1,0xE1F8,
	0x4011,0x9FE1,0xE1FE,0x4000,0x9FE1,0xE1FE,0x4000,0x9F81,
	0xE07E,0x4000,0x9F81,0xE07E,0x4000,0x9F81,0xE07E,0x4000,
	0x9F81,0xE07E,0x4000,0x9E01,0xE01E,0x4000,0x9E01,0xE01E,
	0x7FFF,0x9801,0xE006,0x7C01,0x9801,0xE006,0x7C01,0x8000,
	0x0000,0x7C01,0x8000,0x0000,0x7C01,0x8000,0x0000,0x7C01,
	0xFFFF,0xFFFF,0xFC01 };

void put_logos (ACC_str *as, int combi);

ULONG MOD_main (int Mode, ACC_str *As)
{
int i = As->y, combi;

	switch (Mode)
	{
	case M_INIT:
		MOD_struct.U.b = 0x003f;	/* Fonctionne sur tous les modŠles */
		v_opnvwk (As->work_in, &handle, As->work_out);	/* Station de travail */
		if (! handle)		/* Si problŠme, */
			return (0);		/* ciao madame */

/* Si on est en couleur, r‚servons un buffer de travail qui servira
	 … transformer les bitmaps mono en couleur.
	 La taille de la r‚servation se base sur le logo le plus "gros", celui
	 d'Application Systems. */
		if (As->planes > 1)
			buffer = (int *)Malloc (600 * As->planes);

		pxy[0] = As->x;				/* Clipper l'‚cran */
		pxy[1] = As->y;
		pxy[2] = As->x + As->w;
		pxy[3] = As->y + As->h;
		vs_clip (handle, 1, pxy);

		break;
	case M_SWITCH:
		if (entete.Valeurs[0])	/* Si l'effacement d'‚cran est demand‚ */
		{	/* Nous faisons "sortir" l'‚cran vers le bas */
			pxy[0] = As->x;
			pxy[1] = As->y;
			pxy[2] = As->w;
			pxy[3] = As->h - 10;
			pxy[4] = pxy[0];
			pxy[5] = pxy[1] + 10;
			pxy[6] = As->w;
			pxy[7] = As->h;		/* D‚caler l'‚cran de 10 pixels vers le bas */
			vro_cpyfm (handle, S_ONLY, pxy, &nul, &nul);
			pxy[3] = 10;			/* Vider les 10 pixels du haut */
			v_bar (handle, pxy);
			pxy[3] = As->h - 10;
			do
			{									/* D‚caler l'‚cran de 10 pixels vers le bas */
				vro_cpyfm (handle, S_ONLY, pxy, &nul, &nul);
				i += 10;
			} while (i < As->h);		/* Jusqu'en bas */
		}
		break;
	case M_DO_IT:
		if (entete.Valeurs[2] == 0)	/* Mode de combinaison Source / Destination */
			combi = S_ONLY;				/* Mode remplacement */
		else if (entete.Valeurs[2] == 1)
			combi = S_XOR_D;				/* Mode XOR */
		do		/* Boucle principale */
			put_logos (As, combi);
		while (EVNT_ask (1) == 0);	/* Devons-nous sortir ? */
		break;
	case M_EXIT:
		if (As->planes > 1)		/* S'il y avait buffer de travail, */
			Mfree (buffer);			/* le lib‚rer. */
		if (handle);
			v_clsvwk (handle);	/* Fermer station de travail */
		break;
	}
	return (1);		/* A la prochaine */
}

void put_logos (ACC_str *as, int combi)
{
int i, j, k, *ptr1, *ptr2;
long x, y, r, m;
MFDB img;

	EVNT_ask (entete.Valeurs[1] * 200L);	/* D‚lai (paramŠtre vitesse) */

	x = y = r = m = Random();
	r = rnd24 (r) % 4;	/* Tirage al‚atoire du logo */
	if (r == 0)
	{
		img.fd_addr = apsy;	/* On pointe sur les donn‚es d'image voulues */
		img.fd_w = 77;			/* Largeur en points */
		img.fd_h = 60;			/* Hauteur en points */
		img.fd_wdwidth = 5;	/* Largeur en mots */
	}
	else if (r == 1)
	{
		img.fd_addr = stm;
		img.fd_w = 62;
		img.fd_h = 60;
		img.fd_wdwidth = 4;
	}
	else if (r == 2)
	{
		img.fd_addr = mid;
		img.fd_w = 81;
		img.fd_h = 27;
		img.fd_wdwidth = 6;
	}
	else if (r == 3)
	{
		img.fd_addr = ata;
		img.fd_w = 34;
		img.fd_h = 33;
		img.fd_wdwidth = 3;
	}
	img.fd_nplanes = as->planes;	/* Nbre de plans de couleurs */
	img.fd_stand = 1;

	if (as->planes > 1)
	{
		m = Random () % 4;	/* Masque al‚atoire pour la couleur */
	/* C'est plus commode de travailler avec des pointeurs */
		ptr1 = buffer;							/* Pointeur sur le buffer de travail */
		ptr2 = (int *)img.fd_addr;	/* Pointeur sur les donn‚es d'image */
		for (i = 0 ; i < (img.fd_h - 1) ; i++)					/* Pour chaque ligne */
		{
			for (j = 0 ; j < (img.fd_wdwidth + 1) ; j++)	/* Pour chaque rang‚e */
			{
				*ptr1 = *ptr2;		/* Copier le mot */
				ptr1++;						/* Se placer sur le mot suivant du buffer */
				for (k = 1 ; k < img.fd_nplanes ; k++)			/* Pour chaque plan */
				{
					if (m == 0)					/* Combinaison pour les couleurs */
						*ptr1 = 0;
					else if (m == 1)
						*ptr1 = 0xFFFF;
					else if (m == 2)
						*ptr1 = *ptr2;
					else if (m == 3)
						*ptr1 = ~(*ptr2);
					ptr1++;
				}
				ptr2++;						/* Se placer sur le mot suivant des donn‚es */
			}
		}
		img.fd_addr = buffer;	/* Pointer sur les donn‚es du buffer */
	}

	pxy[0] = 0;						/* "Encadrer" l'image source */
	pxy[1] = 0;
	pxy[2] = img.fd_w - 1;
	pxy[3] = img.fd_h - 1;
	x = rnd24 (x) % ((as->x + as->w) - img.fd_w);	/* Position … l'‚cran */
	y = rnd24 (y) % ((as->y + as->h) - img.fd_h);	/* sans d‚border ! */
	pxy[4] = (int) x;			/* "Encadrer la destination */
	pxy[5] = (int) y;
	pxy[6] = pxy[4] + pxy[2];
	pxy[7] = pxy[5] + pxy[3];
		/* Copie raster selon mode de combinaison choisi */
	vro_cpyfm (handle, combi, pxy, &img, &nul);
}

